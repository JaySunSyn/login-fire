<!--
@license
Copyright (c) 2016 Convoo All Rights Reserved.
Use of this source code is governed by a MIT license that can be found in the
LICENSE file or at https://github.com/convoo/login-fire/blob/master/LICENSE.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymerfire/firebase-auth.html">
<link rel="import" href="./login-fire-form-behavior.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="./icons.html">

<!--
An element that allows simple configuration of email and password authentication with Firebase.

Example:
```
<firebase-app
  name="myApp"
  api-key="API_KEY"
  auth-domain="AUTH_DOMAIN"
  database-url="DATABASE_URL">
</firebase-app>
<login-fire-form app-name="myApp"></login-fire-form>
```

### Styling

Style the buttons with CSS as you would a normal DOM element. 

The following custom properties and mixins are available for styling:

| Custom property | Description | Default |
| --- | --- | --- |
| `--login-fire-reset-password-color` | The color of reset password text | `gray` |
| `--login-fire-reset-password-hover-color` | The color of reset password text when hovered | `gray` |
| `--login-fire-error-msg-color` | The color for the error message  | `--error-color` |
| `--login-fire-info-msg-color` | The color for the info message | `gray` |
| `--login-fire-divider-color` | The color for the divider bar | `gray` |
| `--login-fire-background-color` | The color for the divider bar | `white` |
| `--login-fire-btn-signup` | Mixin applied to the signup button | `{}` |
| `--login-fire-btn-signin` | Mixin applied to the signin button | `{}` |
| `--login-fire-btn-signout` | Mixin applied to the signin button | `{}` |


### Localization

You can specify the following codes and language in a json file passed to the localesFile property to update the text used. Here are the defaults:

"en": {
        "lf-email": "Email",
        "lf-email-invalid": "Invalid email address",
        "lf-password": "Password",
        "lf-reenter-password": "Re-enter Password",
        "lf-passwords-dont-match": "Passwords do not match",
        "lf-already-have-account": "Already have an account?",
        "lf-already-have-account-action": "Sign in",
        "lf-no-account": "Don' have an account?",
        "lf-no-account-action": "Sign up",
        "lf-resetpw-link": "Forgot password",
        "lf-resetpw-cancel-link": "Nevermind, I remembered my password.",
        "lf-resetpw-button": "Reset password",
        "lf-resetpw-success-message": "Password reset email has been sent. Please check your inbox.",
        "lf-signup-button": "Sign Up",
        "lf-signin-button": "Sign In"
        "lf-signout": "Sign out"
    }


@demo demo/login-fire-form.html
-->
<dom-module id="login-fire-form">
  <template>
    <style>
    :host {
      display: block;
      @apply(--login-fire-form);
    }
     paper-button.btn--signup {
         margin: 15px 0;
        @apply(--login-fire-btn-signup);
    }
     paper-button.btn--signin {
        @apply(--login-fire-btn-signin);
    }
    .btn{
        color: gray;
    }
    .link--reset-pw {
      color: var(--login-fire-reset-password-color, gray);
      text-decoration: none;
      font-size: 12px;
      font-style: italic;
      font-weight: lighter;
      cursor: pointer;
    }
    .link--reset-pw:hover{
      color: var(--login-fire-reset-password-hover-color, gray);
      text-decoration: underline;
    }
    .msg {
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      line-height: 24px;
      margin: 0;
      padding: 0;
    }
    .msg--error {
      color: var(--login-fire-error-msg-color, --error-color);
    }
    .msg--info {
      color: var(--login-fire-info-msg-color, gray);
    }
    form {
      min-width: 200px;
      margin: 0 auto;
    }
    .action {
        text-align: center;
    }
    .action paper-button {
        width: 100%;
    }
    .signup-toggle {
        font-size: 12px;
        color:grey;
        text-align: center;
        @apply(--login-fire-form-toggle);
    }
    .signup-toggle a {
        text-decoration: underline;
        cursor: pointer;
    }
    </style>

    <div>
      <div class="msg msg--error" hidden$="[[!_lastError]]">
        <span>[[_lastError]]</span>
      </div>
      <div class="msg msg--info" hidden$="[[!_lastMessage]]">
        <span>[[_lastMessage]]</span>
      </div>
    </div>

    <form>
        <template is="dom-if" if="[[!showResetPW]]">
            <paper-input id="emailInput"
                type="email"
                label="{{localize('lf-email')}}"
                value="{{email}}"
                error-message="{{localize('lf-email-invalid')}}"
                required>
            </paper-input>
            <paper-input id="passwordInput"
                type="password"
                label="{{localize('lf-password')}}"
                value="{{password}}"
                error-message="{{localize('lf-password-invalid')}}"
                required>
                <template is="dom-if" if="[[!noToggleablePassword]]">
                    <paper-icon-button 
                        id="passwordIconButton"
                        suffix
                        on-down="_revealPW"
                        on-up="_hidePW"
                        icon="login-fire-icons:visibility"
                        title="Hold to view password text">
                    </paper-icon-button>
                </template>
            </paper-input>
            <template is="dom-if" if="[[showSignUp]]">
                
                <template is="dom-if" if="[[repeatPassword]]">
                    <paper-input id="repeatPasswordInput"
                        type="password"
                        label="{{localize('lf-reenter-password')}}"
                        value="{{passwordAgain}}"
                        error-message="{{localize('lf-passwords-dont-match')}}"
                        required>
                    </paper-input>
                </template>
                

                <div class="action">
                    <paper-button raised$="[[!flat]]" type="submit" on-tap="_signUp" class="btn--signup">{{localize('lf-signup-button')}}</paper-button>
                </div>
                <p class="signup-toggle">
                    {{localize('lf-already-have-account')}} <a on-tap="_toggleShowSignUp" tabindex="0" title="{{localize('lf-already-have-account')}} {{localize('lf-already-have-account-action')}}" href="#" on-tap="">{{localize('lf-already-have-account-action')}}</a>
                </p>
            </template>
            <template is="dom-if" if="[[!showSignUp]]">
                <p>
                    <a class="link--reset-pw" on-click="toggleShowResetPW" tabindex="0" href="#" on-tap="">
                        {{localize('lf-resetpw-link')}}
                    </a>
                </p>
                <div class="action">
                    <paper-button raised$="[[!flat]]" type="submit" on-tap="_signIn" class="btn--signin">{{localize('lf-signin-button')}}</paper-button>
                </div>
                <p class="signup-toggle">
                    {{localize('lf-no-account')}} <a on-tap="_toggleShowSignUp" tabindex="0" title="{{localize('lf-no-account')}} {{localize('lf-no-account-action')}}" href="#" on-tap="">{{localize('lf-no-account-action')}}</a>
                </p>
            </template>
        </template>
        <template is="dom-if" if="[[showResetPW]]">
            <paper-input id="resetEmailInput"
                type="email"
                label="Email"
                value="{{email}}"
                error-message="Invalid email address"
                required>
            </paper-input>
            <paper-button raised$="[[!flat]]" type="submit" on-tap="_resetPassword" class="btn--resetpw">{{localize('lf-resetpw-button')}}</paper-button>
            <p>
                <a class="link--reset-pw" on-click="toggleShowResetPW" tabindex="0" href="#" on-tap="">
                    {{localize('lf-resetpw-cancel-link')}}
                </a>
            </p>
        </template>
    </form>

    <firebase-auth id="auth"
      app-name="[[appName]]"
      user="{{_user}}"
      signed-in="{{_signedIn}}"
      status-known="{{_statusKnown}}">
    </firebase-auth>
  </template>

  <script>
  Polymer({
    is: 'login-fire-form',
    behaviors: [Convoo.LoginFireFormBehavior],

    properties: {
      /**
       * If true, will sign up a user who attempts to sign in with an account
       * that doesn't already exist.
       *
       * @type {Boolean}
       */
      autoSignUp: {
        type: Boolean,
        value: false
      },

      /**
       * Provider ID to use for Firebase Auth.
       *
       * @type {String}
       */
      provider: {
        type: String,
        readOnly: true,
        notify: false,
        value: 'password'
      },

      /**
       * Last error message.
       *
       * @type {String}
       */
      _lastError: {
        type: String
      },

      /**
       * Last message info.
       *
       * @type {String}
       */
      _lastMessage: {
        type: String
      }
    },

    listeners: {
      'error': '_handleError'
    },

    /**
     * Cleans message and error sections.
     */
    _cleanMessages: function() {
      this.set('_lastError', '');
      this.set('_lastMessage', '');
    },

    /**
     * Tries to sign in a user using the form values.
     */
    _signIn: function() {
      this._cleanMessages();
      e = this.$$("#emailInput").validate();
      p = this.$$("#passwordInput").validate();
      if (e && p){
        this.signIn(this.email, this.password);
      }
    },

    /**
     * Tries to sign-up a user using the form values.
     */
    _signUp: function(e) {
        this._cleanMessages();
        e = this.$$("#emailInput").validate()
        p = this.$$("#passwordInput").validate()
        if (this.reenterPassword){
            this.$$("#repeatPasswordInput").invalid=false;
            pRepeat = this.password == this.passwordAgain && this.$$("#repeatPasswordInput").validate()
            if (e && p && pRepeat) {
                this.signUp(this.email, this.password);
                this.email = null;
                this.password = null;
                this.passwordAgain = null;
            }else if(!pRepeat){
                this.$$("#repeatPasswordInput").invalid=true;
            }
        } else {
            if (e && p){
                this.signUp(this.email, this.password);
                this.email = null;
                this.password = null;
            }
        }
    },

    /**
     * Displays error message. If the attribute `autoSignUp` is true, before
     * to display the error message, a sign-up process is tried.
     *
     * @param  {Object} e the event caught that contains the error message
     */
    _handleError: function(e) {
      if (this.autoSignUp && e.detail.code === 'auth/user-not-found') {
        this.signUp(this.email, this.password);
        this.email = null;
        this.password = null;
      } else {
        this.set('_lastError', e.detail.message);
      }
    },

    /**
     * Sends an email for resetting the account password. The email is sent to
     * the address entered in the form when the user clicks on the link to reset
     * its password.
     */
    _resetPassword: function() {
      this._cleanMessages();
      e = this.$$("#resetEmailInput").validate() 
      if (e){
        this.$$("#auth").auth.sendPasswordResetEmail(this.email).then(function() {
            this.set('_lastMessage', this.localize('lf-resetpw-success-message'));
        }.bind(this), function (error) {
            this.set('_lastError', error.message);
        }.bind(this));
      }
    },

    /*
     *  Reveals the password in the parent by switching the type to text
     */
     _revealPW: function(e){
        this.$$("#passwordIconButton").icon = "login-fire-icons:visibility-off";
        this.$$("#passwordInput").type = "text";
     },

     /*
      * Hides the password in the parent by switching the type to password
      */
     _hidePW: function(e){
        this.$$("#passwordIconButton").icon = "login-fire-icons:visibility";
        this.$$("#passwordInput").type = "password";
     }
  });
  </script>
</dom-module>
